package jgossit.server;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.TimeZone;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.codec.binary.Base64;

import com.google.appengine.api.images.Composite;
import com.google.appengine.api.images.Image;
import com.google.appengine.api.images.ImagesService;
import com.google.appengine.api.images.ImagesServiceFactory;
import com.google.appengine.api.images.Transform;

public class DaysToGoServlet  extends HttpServlet
{
	private static final long serialVersionUID = 1L;
	
	private static final ImagesService IMAGES_SERVICE = ImagesServiceFactory.getImagesService();
	private static final Pattern DATE_PATTERN = Pattern.compile("(\\d{4})-(\\d{1,2})-(\\d{1,2})");
	// png image data for numbers 0-9
	private static final String NUMBERS_IMAGE_DATA = "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";
	private static final byte[] NUMBERS_IMAGE_BYTES = Base64.decodeBase64(NUMBERS_IMAGE_DATA);
	private static final int NUMBER_IMAGE_WIDTH = 24;
	private static final int NUMBER_IMAGE_HEIGHT = 37;
	private static final Image[] NUMBER_IMAGES = new Image[10];
	static
	{
		for (int i=0; i<10; i++)
		{
			Transform transform = ImagesServiceFactory.makeCrop(i*0.1, 0.0, (i+1)*0.1, 1.0); // 0.1 = 10% of 0.0 to 1.0 limit
			NUMBER_IMAGES[i] = IMAGES_SERVICE.applyTransform(transform, ImagesServiceFactory.makeImage(NUMBERS_IMAGE_BYTES));
		}
	}
	// png image data for 'days to go'
	private static final String DAYSTOGO_IMAGE_DATA = "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";
	private static final byte[] DAYSTOGO_IMAGE_BYTES = Base64.decodeBase64(DAYSTOGO_IMAGE_DATA);
	private static final Image DAYSTOGO_IMAGE = ImagesServiceFactory.makeImage(DAYSTOGO_IMAGE_BYTES);
	private static final int DAYSTOGO_IMAGE_WIDTH = 110;
	private static final int DAYSTOGO_IMAGE_HEIGHT = 24;
	
	public void doPost(HttpServletRequest req, HttpServletResponse resp) throws IOException
	{
		String date = req.getParameter("date");
		if (date == null)
			return;
		Matcher matcher = DATE_PATTERN.matcher(date);
		if (!matcher.matches())
			return;
		int year = Integer.parseInt(matcher.group(1));
		int month = Integer.parseInt(matcher.group(2));
		int day = Integer.parseInt(matcher.group(3));
		if (year < 2013 || month < 1 || month > 12 || day < 1 || day > 31)
			return;
		
		byte[] imageData = createImage(year, month, day);
		resp.setContentType("image/png");
		resp.setContentLength(imageData.length);
		resp.getOutputStream().write(imageData);
		//String imageDataBase64 = Base64.encodeBase64String(imageData);
		//resp.getWriter().print("<img src=\"data:image/png;base64," + imageDataBase64 + "\" />");
	}
	
	private byte[] createImage(int year, int month, int day)
	{
		Calendar calendarNow = Calendar.getInstance(TimeZone.getTimeZone("Australia/Melbourne"));
		calendarNow.setTimeInMillis(System.currentTimeMillis());
		Calendar calendarThen = Calendar.getInstance(TimeZone.getTimeZone("Australia/Melbourne"));
		calendarThen.set(year, month-1, day, 23, 59, 59);
		long diff = calendarThen.getTimeInMillis() - calendarNow.getTimeInMillis();
		int daysToGo = (int)Math.floor( diff / (24 * 60 * 60 * 1000) );
		if (daysToGo < 0)
			daysToGo = 0;
		String daysToGoString = ""+daysToGo;
		
		int daysToGoNumbersImageWidth = (daysToGoString.length() * NUMBER_IMAGE_WIDTH) + ((daysToGoString.length()-1) * 1); // 1px space
		int outputImageWidth = Math.max(daysToGoNumbersImageWidth, DAYSTOGO_IMAGE_WIDTH);
		int daysToGoNumbersImagePadding = 0;
		int daysToGoTextImagePadding = 0;
		if (daysToGoNumbersImageWidth < outputImageWidth)
			daysToGoNumbersImagePadding = (int) Math.floor((DAYSTOGO_IMAGE_WIDTH - daysToGoNumbersImageWidth) / 2);
		else
			daysToGoTextImagePadding = (int) Math.floor((daysToGoNumbersImageWidth - DAYSTOGO_IMAGE_WIDTH) / 2);
		
		ArrayList<Composite> composites = new ArrayList<Composite>();
		int xOffset = daysToGoNumbersImagePadding;
		for (int i=0;i<daysToGoString.length();i++)
		{
			int daysToGoNumber = Integer.parseInt(daysToGoString.substring(i,i+1));
			composites.add( ImagesServiceFactory.makeComposite(NUMBER_IMAGES[daysToGoNumber], xOffset, 0, 1.0f, Composite.Anchor.TOP_LEFT) );
			xOffset += NUMBER_IMAGE_WIDTH + 1; // 1px spacing
		}
		
		composites.add( ImagesServiceFactory.makeComposite(DAYSTOGO_IMAGE, daysToGoTextImagePadding, NUMBER_IMAGE_HEIGHT + 10, 1.0f, Composite.Anchor.TOP_LEFT) );  // 10px spacing
			
		Image output = IMAGES_SERVICE.composite(composites, outputImageWidth, NUMBER_IMAGE_HEIGHT + 10 + DAYSTOGO_IMAGE_HEIGHT, 0, ImagesService.OutputEncoding.PNG);
		byte[] imageData = output.getImageData();
		return imageData;
	}
	
	public void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException
	{
		doPost(req, resp);
	}
}